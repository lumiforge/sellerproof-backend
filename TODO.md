# Цель
нужно изменить модель подписок так чтобы было всего три вида подписок:
| Тариф        | Заказы с видеоподтверждением / мес | Хранение видео | Пользователи | Цена        |
| ------------ | ---------------------------------- | -------------- | ------------ | ----------- |
| **START**    | до **300**                         | **12 месяцев** | безлимит     | **1 490 ₽** |
| **PRO**      | до **1 000**                       | **24 месяца**  | безлимит     | **3 490 ₽** |
| **BUSINESS** | до **3 000**                       | **36 месяцев** | безлимит     | **6 990 ₽** | 

free не было совсем.

## Задача

1. **Срок хранения уже реализован через разные бакеты Yandex Object Storage:**
   - `sub12-ice` — бакет с TTL 12 месяцев
   - `sub24-ice` — бакет с TTL 24 месяца
   - `sub36-ice` — бакет с TTL 36 месяцев

2. **Логика работы:** При загрузке видео оно сохраняется в соответствующий бакет в зависимости от плана подписки, и TTL настроен на уровне Object Storage, а не в базе данных.

## Список изменений

Для перехода на новую модель подписок **нужно изменить только:**

### 1. **Таблица `plans`** — изменить поле на лимит заказов:
- Убрать: `video_count_limit` (количество видео)
- Добавить: `orders_per_month_limit` (лимит заказов в месяц)

### 2. **Таблица `subscriptions`** — аналогично:
- Убрать: `video_count_limit`
- Добавить: `orders_per_month_limit`

### 3. **Модели Go** (`types.go`):
```go
type Plan struct {
    // ... остальные поля
    OrdersPerMonthLimit int64 `db:"orders_per_month_limit"` // вместо VideoCountLimit
}

type Subscription struct {
    // ... остальные поля
    OrdersPerMonthLimit int64 `db:"orders_per_month_limit"` // вместо VideoCountLimit
}
```

### 4. **Конфигурация** (`config.go`):
- Переименовать планы: `free` → `start`, `enterprise` → `business`
- Заменить переменные `VideoCountLimit*` на `OrdersPerMonthLimit*`
- Обновить значения:
  - START: 300 заказов, 1490₽
  - PRO: 1000 заказов, 3490₽
  - BUSINESS: 3000 заказов, 6990₽

### 5. **Инициализация планов** в `createTables()`:
```go
REPLACE INTO plans (plan_id, name, video_limit_mb, orders_per_month_limit, price_rub, billing_cycle, features, created_at, updated_at)
VALUES
('start', 'START', 512, 300, 1490.0, 'monthly', '{"retention_months": 12}', CurrentUtcTimestamp(), CurrentUtcTimestamp()),
('pro', 'PRO', 2048, 1000, 3490.0, 'monthly', '{"retention_months": 24}', CurrentUtcTimestamp(), CurrentUtcTimestamp()),
('business', 'BUSINESS', 10240, 3000, 6990.0, 'monthly', '{"retention_months": 36}', CurrentUtcTimestamp(), CurrentUtcTimestamp())
```

**Примечание:** Срок хранения можно добавить в JSON-поле `features` для информационных целей, чтобы API возвращал эту информацию клиентам, а обработка TTL остается на уровне Object Storage.

Детали:

1.  **Логика "Заказы vs Видео"**:
    В текущей реализации система считает количество *видео* (`SELECT COUNT(*) FROM videos`). В новом ТЗ указан лимит "Заказы с видеоподтверждением".
    *   **Пояснение:** Ключевой момент: Multipart upload в текущей реализации — это техническая деталь загрузки одного видео, а не несколько отдельных видео. Поля PartsUploaded и TotalParts используются для отслеживания прогресса загрузки одного файла, разбитого на части. 1 запись в таблице videos = 1 заказ с видеоподтверждением.

2.  **Лимит по объему (MB)**:
    В текстовом описании тарифов колонка с объемом хранилища (MB/GB) отсутствует (указан только срок хранения). Однако в вашем примере SQL-запроса (`REPLACE INTO plans...`) поле `video_limit_mb` присутствует и имеет значения (512, 2048, 10240).
    *   **Пояснение:** Нужно сохранять жесткие лимиты по объему, но исправить на 600ГB/2000GB/6000GB (из расчета 2ГБ на количество видео);

3.  **Миграция существующих данных**:
    Вы написали "free не было совсем", но в коде есть планы `free` и `enterprise`.
    * **Пояснение:** Это "чистый" запуск, старые данные не важны (можно дропнуть таблицы или игнорировать старые ID).

4.  **Регистрация и Trial-период**:
    В текущем коде (`internal/auth/service.go`) при регистрации пользователю выдается план `free` как триал.
    *   **Пояснение:** Какой план выдавать при регистрации теперь: используем план START с флагом IsActive = false и ExpiresAt =now;

5.  **Переменные окружения (Config)**:
    В `config.go` есть переменные `SPObjStoreBucketFree`, `SPObjStoreBucketPro` и т.д.
    *   **Пояснение:** Следует переименовать эти переменные в конфиге, чтобы они соответствовали новым планам (например, `SPObjStoreBucketStart`);

6.  **Обработка превышения лимита**:
    *   **Вопрос:** Оставляем жесткую ошибку 403 Forbidden при превышении лимита;

**Важно:** это production-ready решение, это **не** MVP, писать только production-ready код.



