# Как это работает

## Multipart Upload
**Multipart Upload** — это стандартная функциональность протокола S3, которая включает три операции:

1. **InitiateMultipartUpload** — создает сессию загрузки и возвращает `upload_id`
2. **UploadPart** — загружает отдельные части файла (каждая часть получает номер и ETag)
3. **CompleteMultipartUpload** — отправляет список всех частей с их ETag, и хранилище автоматически собирает их в единый объект

Облачное хранилище (S3, Yandex Object Storage, MinIO и другие S3-совместимые) само знает, как:
- Хранить части временно до завершения загрузки
- Проверять целостность по ETag
- Собирать части в правильном порядке в финальный файл
- Делать это эффективно без копирования данных

## Sellerproof

Использует клиент storage (AWS SDK v2 для Go), который просто вызывает стандартные S3 API:

- `s.storage.InitiateMultipartUpload()` — инициирует сессию
- `s.storage.GeneratePresignedPartURL()` — генерирует временные ссылки для загрузки частей
- `s.storage.CompleteMultipartUpload()` — завершает загрузку, передавая массив частей

Само объединение происходит "магически" внутри Object Storage — backend просто отправляет команду "завершить multipart upload вот с этими частями", и хранилище делает всю работу. Вся тяжелая работа по сборке файла делегируется инфраструктуре хранилища.

Механизм загрузки видео через multipart-загрузку в sellerproof-backend состоит из трех последовательных этапов и организован через несколько защищённых REST эндпоинтов:


#### 1. Инициализация загрузки (POST /api/v1/video/upload/initiate)

- Клиент с валидным JWT-токеном отправляет запрос c параметрами файла: `file_name`, `file_size_bytes`, `duration_seconds`.
- Сервер валидирует права (RBAC), параметры, а также проверяет, не превышен ли лимит хранилища (в зависимости от тарифа/организации).
- Затем система генерирует уникальный идентификатор видео (`video_id`), формирует путь для хранения на S3/Yandex Object Storage и инициирует multipart upload через сторедж-клиент — в ответе возвращает:  
  - `video_id` — идентификатор,  
  - `upload_id` — идентификатор multipart сессии хранилища,  
  - `recommended_part_size_mb` — рекомендуемый размер каждой части для загрузки.
- После успешной инициализации создаётся запись видео в базе (YDB) в статусе "pending".

#### 2. Получение ссылок для загрузки частей (POST /api/v1/video/upload/urls)

- Клиент отправляет идентификатор видео и количество частей.
- Сервер валидирует пользователя и права доступа, извлекает запись по video_id, далее вызывает генерацию набора временных ссылок (`presigned URLs`) на части файла — каждая ссылка позволяет безопасно загружать один фрагмент видео непосредственно в хранилище (S3/Yandex.ObjectStorage) с ограниченным временем действия. 
- В ответ возвращается массив временных URL (по числу частей) и дата их истечения.

### 3. Завершение загрузки (POST /api/v1/video/upload/complete)
- Клиент загружает каждую часть файла отдельно по пресайновой ссылке. Каждая часть получает свой уникальный номер (partNumber), который указывается в запросе загрузки. Облачное хранилище (S3 или Yandex Object Storage) сохраняет эти части, связывая их с сессией `uploadId`.

- После того как все части загружены, клиент вызывает endpoint **POST /api/v1/video/upload/complete**, передавая на сервер массив частей с полями `{part_number, etag}`. Этег (etag) — это хеш кажой загруженной части, который сервер использует для проверки целостности.

- Сервер получает этот список, проверяет права пользователя и видео, а затем вызывает метод облачного хранилища для завершения multipart upload, передавая туда массив частей с номерами и этегами именно в том порядке, в котором они должны быть склеены.

- Облачное хранилище на основании этих данных объединяет загруженные части в единый файл — гарантируя правильный порядок и целостность.

Таким образом, нумерация частей и этеги передаются серверу на этапе завершения загрузки для точного и безопасного контроля склейки файла в хранилище. Сам процесс загрузки частей происходит независимо через отдельные URL, а порядок и сборка фиксируются при finalize-операции с участием сервера.

Это стандартный и проверенный механизм multipart upload, хорошо поддерживаемый AWS S3 и совместимыми хранилищами.

***

#### Схема обмена

1. **POST initiate:** сервер создаёт запись, инициирует multipart upload, клиент получает upload_id и video_id.
2. **POST urls:** клиент с video_id запрашивает пресайновые ссылки — каждая часть загружается напрямую в облако.
3. **POST complete:** сервер проверяет части, завершает загрузку в облаке, обновляет статус видео.

***

Такой подход позволяет:
- Эффективно загружать большие видеофайлы, не «тарясь» на сервере.
- Контролировать объём и квоту на стороне бэкенда.
- Давать granular-авторизацию и аудит по пользователю/организации.
- Уменьшать риск обрывов/потерь, позволяя докачивать части.

Все детали механизма жестко связаны с Authorize/RBAC, квотами, записью операций в YDB и интеграцией c облачным хранилищем.[1]

Требования облачных хранилищ для multipart-загрузки накладывают следующие ограничения на размер частей:

## Yandex Object Storage

### Размер части (Part Size)
- **Минимум:** 5 МБ для всех частей, кроме последней[5]
- **Последняя часть:** может быть любого размера[5]

### Общие ограничения
- **Максимальный размер объекта:** 5 ТБ[5]
- **Максимальное количество частей:** 10,000 частей в multipart upload[5]
- **Максимальный размер данных за запрос:** 5 ГБ[5]
- **Порог по умолчанию для multipart:** 8 МБ[6]
- **Размер chunk по умолчанию:** 8 МБ[6]

## Важные моменты

1. **Последняя часть** — единственная часть, которая может быть меньше минимума (5 МБ).
2. **Лимит 10,000 частей** означает, что для очень больших файлов нужно увеличивать размер части (например, для файла 5 ТБ минимальный размер части будет ~524 МБ).
3. **Параллельная загрузка** — части можно загружать параллельно и в любом порядке.[4][1]
4. **Возобновляемость** — при сбое можно перезагрузить только неудачные части.[4]

В контексте sellerproof-backend рекомендация 10 МБ соответствует этим требованиям и находится в безопасном диапазоне для обоих облачных провайдеров.[1][5]

[1](https://docs.aws.amazon.com/AmazonS3/latest/userguide/qfacts.html)
[2](https://stackoverflow.com/questions/47078349/what-is-the-maximum-file-size-for-using-multipart-upload-in-s3)
[3](https://docs.aws.amazon.com/AmazonS3/latest/userguide/mpuoverview.html)
[4](https://www.multcloud.com/tutorials/amazon-s3-upload-limit-2223-gc.html)
[5](https://yandex.cloud/en/docs/storage/concepts/limits)
[6](https://yandex.cloud/en/docs/storage/operations/objects/upload)
[7](https://www.reddit.com/r/aws/comments/ue6b34/how_to_limit_s3_multipart_upload_size/)
[8](https://storj.dev/dcs/api/s3/multipart-upload/multipart-part-size)
[9](https://aws.amazon.com/blogs/compute/uploading-large-objects-to-amazon-s3-using-multipart-upload-and-transfer-acceleration/)
[10](https://www.alter-solutions.com/articles/multipart-upload-amazon-s3)
