# Техническое задание: Внедрение Unit-тестирования (Mock-based)

**Приоритет:** Высокий
**Исполнитель:** QA Automation / Backend Developer
**Контекст:** Проект работает в Yandex Cloud (Functions + YDB + S3). Локального доступа к инфраструктуре нет.

### 1. Цель задачи
Обеспечить возможность **локального** тестирования бизнес-логики и обработки ошибок без необходимости деплоя в облако. Это ускорит разработку и поможет ловить баги логики (if/else) до того, как код попадет в Cloud Function.

### 2. Строгие ограничения (Constraints)
*   ⛔ **ЗАПРЕЩЕНО:** Переносить, дублировать или удалять логику из существующих Bruno-тестов (`docs/SellerProof API`).
*   ⛔ **ЗАПРЕЩЕНО:** Пытаться поднять локальные докер-контейнеры с YDB или S3 (используем только моки).
*   ⛔ **ЗАПРЕЩЕНО:** Менять существующий код в проекте для тестирования (например, выполнить моки или заменить на моки все интерфейсы к БД или S3).

### 3. Объем работ (Scope)

#### Этап 1: Генерация Моков (Mocks)
Необходимо сгенерировать мок-объекты для внешних зависимостей, чтобы изолировать бизнес-логику.
*   **Инструмент:** `vektra/mockery` или `uber-go/mock`.
*   **Что мокать:**
    1.  Интерфейс `Database` (в `internal/ydb/interface.go`).
    2.  Клиент S3 (рекомендуется выделить методы `storage.Client` в интерфейс `StorageProvider` и замокать его).
    3.  `JWTManager` (можно использовать реальный с тестовым секретом, либо замокать).

#### Этап 2: Тестирование Сервисного слоя (`internal/auth`, `internal/video`)
Написать тесты на Go для проверки бизнес-правил.
*   **Что тестировать:**
    *   **Auth Service:**
        *   Успешная регистрация (вызов `CreateUser` в моке).
        *   Обработка ошибки "User already exists" от мока БД.
        *   Логика переключения организаций (`SwitchOrganization`).
        *   Проверка прав (RBAC) — например, "Менеджер не может удалить Админа".
    *   **Video Service:**
        *   Проверка квот (Storage Limit) перед загрузкой.
        *   Логика генерации ссылок (без реального обращения к S3).

#### Этап 3: Тестирование HTTP Хендлеров (`internal/http`)
Использовать `net/http/httptest` для проверки валидации входящих запросов.
*   **Что тестировать:**
    *   Валидация JSON (битый JSON, пустые поля).
    *   Проверка HTTP-методов (405 Method Not Allowed).
    *   Проверка маппинга ошибок (если сервис вернул `ErrPermissionDenied`, хендлер должен вернуть 403).

### 4. Примеры сценариев (Checklist)

**✅ Unit-тест (Go):**
*   *Сценарий:* Попытка логина с неверным паролем.
*   *Реализация:* Мок БД возвращает пользователя. Сервис сравнивает хеши. Ожидаем ошибку `invalid credentials`.
*   *Зачем:* Проверить логику сравнения хешей без сети.

**✅ Unit-тест (Go):**
*   *Сценарий:* Пользователь превысил лимит хранилища.
*   *Реализация:* Мок БД возвращает `StorageUsage = 10GB`. Сервис `InitiateUpload` должен вернуть ошибку.
*   *Зачем:* Проверить математику подсчета квот.

**❌ НЕ делать в Unit-тестах (оставить в Bruno):**
*   Отправка `video_id="<script>alert(1)</script>"`. (Это уже покрыто в Bruno, не дублировать).
*   Проверка реальной записи файла в S3.
*   Проверка реального SQL-запроса к YDB.

### 5. Технические требования к коду тестов
*   Использовать библиотеку `github.com/stretchr/testify` (assert, require, mock).
*   Тесты должны проходить командой `go test ./...` за секунды.
*   Покрытие (Coverage) бизнес-логики стремиться к 60-70%.

### 6. Ожидаемый результат (Definition of Done)
1.  В проекте появились файлы `*_test.go` в папках `internal/auth`, `internal/video`, `internal/http`.
2.  Команда `go test ./...` выполняется локально без ошибок и паник.
3.  Существующие Bruno-тесты не затронуты и продолжают использоваться для проверки деплоя.